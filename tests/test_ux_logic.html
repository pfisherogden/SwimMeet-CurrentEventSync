<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>UX Logic Tests</title>
</head>

<body>
    <h1>UX Logic Tests</h1>
    <div id="results">Running tests...</div>

    <!-- Mocks -->
    <script>
        // Mock localStorage
        const localStorageMock = (function () {
            let store = {};
            return {
                getItem: function (key) {
                    return store[key] || null;
                },
                setItem: function (key, value) {
                    store[key] = value.toString();
                },
                clear: function () {
                    store = {};
                }
            };
        })();

        Object.defineProperty(window, 'localStorage', {
            value: localStorageMock
        });

        // Mock Navigator WakeLock
        navigator.wakeLock = {
            request: async function (type) {
                if (type === 'screen') {
                    return {
                        release: function () { },
                        addEventListener: function () { }
                    };
                }
                throw new Error('Not supported');
            }
        };

        // Mock Fullscreen
        document.documentElement.requestFullscreen = async function () { return true; };
        document.exitFullscreen = async function () { return true; };

    </script>

    <!-- Load App script - Use simple script loading, but we need to inspect internal state or DOM effects -->
    <!-- Since app.js runs on DOMContentLoaded, we just need to simulate the DOM it expects -->
    <div id="app-container">
        <header class="status-bar">
            <span id="connection-status">Connecting...</span>
            <span id="meet-name-display"></span>
            <span id="last-updated">--:--:--</span>
        </header>
        <div id="event-display"></div>
        <div id="heat-display"></div>
        <div id="qrcode"></div>
        <button id="config-btn">Cfg</button>
        <button id="fullscreen-btn">Full</button>
        <button id="theme-btn">Theme</button>
        <div id="config-modal" class="hidden">
            <input id="sheet-id-input">
            <input type="checkbox" id="wakelock-checkbox">
            <button id="save-btn">Save</button>
            <button id="close-modal-btn">Close</button>
        </div>
    </div>

    <script src="../docs/app.js"></script>

    <script>
        function assert(condition, message) {
            const div = document.createElement('div');
            div.textContent = (condition ? "PASS: " : "FAIL: ") + message;
            div.style.color = condition ? "green" : "red";
            document.getElementById('results').appendChild(div);
            if (!condition) {
                console.error("ASSERTION FAILED:", message);
                throw new Error(message);
            }
        }

        async function runTests() {
            // Wait for app init
            await new Promise(r => setTimeout(r, 100));

            // Test 1: Dark Mode Toggle
            console.log("Test 1: Dark Mode");
            const themeBtn = document.getElementById('theme-btn');
            assert(!document.body.classList.contains('dark-mode'), "Body should not have dark-mode initially (default)");

            themeBtn.click();
            assert(document.body.classList.contains('dark-mode'), "Body should have dark-mode after click");
            assert(window.localStorage.getItem('swimMeetDarkMode') === 'true', "LocalStorage should have true");

            themeBtn.click();
            assert(!document.body.classList.contains('dark-mode'), "Body should NOT have dark-mode after 2nd click");
            assert(window.localStorage.getItem('swimMeetDarkMode') === 'false', "LocalStorage should have false");

            // Test 2: Wakelock Setting
            console.log("Test 2: Wakelock");
            const configBtn = document.getElementById('config-btn');
            const saveBtn = document.getElementById('save-btn');
            const wakelockCheckbox = document.getElementById('wakelock-checkbox');

            configBtn.click(); // Open modal logic
            // Directly toggle checkbox
            wakelockCheckbox.checked = true;
            saveBtn.click(); // Trigger save logic

            assert(window.localStorage.getItem('swimMeetWakelock') === 'true', "Wakelock should be saved true in LS");

            // Test 3: Display Update Flash
            // Manually call update logic if we can access it? 
            // We can't access `updateDisplay` directly as it is scoped.
            // But we can trigger a flash by observing DOM if we mock the fetch or data.
            // Since we can't easily mock the internal fetch without modifying app.js structure, 
            // we will skip deep integration testing here and rely on manual verification for visual parts.

            // Final Status
            const finalDiv = document.createElement('div');
            finalDiv.textContent = "ALL TESTS COMPLETED";
            finalDiv.style.fontWeight = "bold";
            document.body.appendChild(finalDiv);
        }

        // Run after load
        window.addEventListener('load', runTests);
    </script>
</body>

</html>